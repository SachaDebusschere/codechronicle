name: GÃ©nÃ©ration Automatique d'Articles

permissions:
    contents: write
    issues: write
    pull-requests: write

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  generate-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: Install dependencies
        run: |
            npm install
      
      - name: GÃ©nÃ©ration des articles
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "RÃ©pertoire de travail : $(pwd)"
          echo "Contenu du rÃ©pertoire courant :"
          ls -la
          echo "Contenu du dossier blog :"
          ls -la blog/
          
          # VÃ©rifier que la clÃ© API est bien prÃ©sente
          echo "ClÃ© API (masquÃ©e) : ${OPENAI_API_KEY:0:4}****"
          
          # Trouver tous les fichiers .md dans le dossier blog
          for file in blog/*.md; do
            if [ -f "$file" ]; then
              echo "Traitement du fichier : $file"
              node scripts/generateArticleOui.js "$file"
            fi
          done
          
          # RÃ©cupÃ©rer la liste des fichiers gÃ©nÃ©rÃ©s
          generated_files=$(find blog -name "*.md" -type f)
          echo "generated_files=${generated_files}" >> $GITHUB_OUTPUT
          
          # VÃ©rifier si le fichier de mÃ©tadonnÃ©es existe
          if [ -f "article-metadata.json" ]; then
            echo "metadata_exists=true" >> $GITHUB_OUTPUT
          else
            echo "metadata_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit et push des changements
        if: steps.generate.outputs.generated_files != ''
        run: |
          git config --local user.email "sacha.debusschere.sd@gmail.com"
          git config --local user.name "Sacha Debusschere"
          git add blog/ article-metadata.json
          git commit -m "GÃ©nÃ©ration automatique d'articles"
          git push
      
      - name: CrÃ©er un artefact avec les articles gÃ©nÃ©rÃ©s
        if: steps.generate.outputs.generated_files != ''
        uses: actions/upload-artifact@v4
        with:
          name: articles-generes
          path: |
            blog/
            article-metadata.json
      
      - name: Ajouter un commentaire sur la PR avec les mÃ©tadonnÃ©es
        if: steps.generate.outputs.metadata_exists == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              // Lire le fichier de mÃ©tadonnÃ©es
              const metadata = JSON.parse(fs.readFileSync('article-metadata.json', 'utf8'));
              
              if (metadata && metadata.length > 0) {
                // Construire le message de commentaire
                let commentBody = "## Articles gÃ©nÃ©rÃ©s par l'IA ðŸ¤–\n\n";
                
                metadata.forEach(article => {
                  commentBody += `### ${article.title}\n`;
                  commentBody += `**RÃ©sumÃ©**: ${article.summary}\n\n`;
                  commentBody += `Fichier: \`blog/${article.file}.md\`\n\n`;
                  commentBody += "---\n\n";
                });
                
                // Ajouter le commentaire Ã  la PR
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                
                console.log('Commentaire ajoutÃ© Ã  la PR avec les dÃ©tails des articles');
              } else {
                console.log('Aucune mÃ©tadonnÃ©e d\'article trouvÃ©e');
              }
            } catch (error) {
              console.error('Erreur lors de la lecture des mÃ©tadonnÃ©es:', error);
              
              // Ajouter un commentaire de secours si les mÃ©tadonnÃ©es ne peuvent pas Ãªtre lues
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "Les articles ont Ã©tÃ© gÃ©nÃ©rÃ©s, mais les dÃ©tails n'ont pas pu Ãªtre rÃ©cupÃ©rÃ©s."
              });
            }
            
      - name: Envoyer les notifications Discord
        if: steps.generate.outputs.metadata_exists == 'true'
        run: |
          # Installer jq si nÃ©cessaire
          if ! command -v jq &> /dev/null; then
            echo "Installation de jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Lire le fichier de mÃ©tadonnÃ©es
          if [ -f "article-metadata.json" ]; then
            # Utiliser jq pour traiter le JSON
            articles=$(cat article-metadata.json)
            count=$(echo "$articles" | jq length)
            
            for i in $(seq 0 $(($count-1))); do
              title=$(echo "$articles" | jq -r ".[$i].title")
              summary=$(echo "$articles" | jq -r ".[$i].summary")
              
              # CrÃ©er une version simplifiÃ©e du message
              title_escaped=$(echo "$title" | sed 's/"/\\"/g')
              summary_escaped=$(echo "$summary" | sed 's/"/\\"/g')
              
              # CrÃ©er le JSON avec une syntaxe plus simple
              cat > discord_payload.json << EOF
              {
                "username": "BOT de Springfield",
                "embeds": [
                  {
                    "title": "Nouvel article gÃ©nÃ©rÃ©",
                    "description": "**Titre**: $title_escaped\n\n**RÃ©sumÃ©**: $summary_escaped\n\nLe lien de l'article arrive bientÃ´t !",
                    "color": 8388736,
                    "footer": {
                      "text": "Github Actions - Automatisation"
                    }
                  }
                ]
              }
              EOF
              
              # Envoyer la notification Discord
              curl -H "Content-Type: application/json" -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" -d @discord_payload.json
              
              echo "Notification Discord envoyÃ©e pour l'article: $title"
              sleep 1
            done
          else
            echo "Aucun fichier de mÃ©tadonnÃ©es trouvÃ©, impossible d'envoyer les notifications Discord"
          fi
      